Correction de la route GET /api/implants/:id/protheses

Je souhaite corriger lâ€™endpoint GET /api/implants/:id/protheses, car il utilise une variable organisationId non dÃ©finie dans la route.

Objectif :
â€“ protÃ©ger la route avec requireJwt
â€“ rÃ©cupÃ©rer correctement organisationId depuis req.jwtUser (ou getOrganisationId)
â€“ lâ€™utiliser pour filtrer les prothÃ¨ses du cabinet du praticien
â€“ renvoyer proprement les donnÃ©es au format JSON

Merci dâ€™appliquer les modifications suivantes :

âœ… 1. Mettre Ã  jour la route GET /api/implants/:id/protheses

Je veux que la route ressemble Ã  ceci (ou Ã©quivalent selon ton helper) :

app.get("/api/implants/:id/protheses", requireJwt, async (req, res) => {
  try {
    const organisationId = getOrganisationId(req, res); 
    if (!organisationId) return;

    const implantId = req.params.id;

    const protheses = await storage.getImplantProtheses(
      organisationId,
      implantId
    );

    return res.json(protheses);
  } catch (err) {
    console.error("Erreur rÃ©cupÃ©ration prothÃ¨ses :", err);
    return res.status(500).json({ error: "Erreur serveur lors de la rÃ©cupÃ©ration des prothÃ¨ses" });
  }
});


Si getOrganisationId nâ€™existe pas ou ne renvoie pas lâ€™ID, utiliser ceci :

const organisationId = req.jwtUser?.organisationId;
if (!organisationId) {
  return res.status(400).json({ error: "Organisation manquante dans le token" });
}

âœ… 2. VÃ©rifier que storage.getImplantProtheses() reste inchangÃ©
async getImplantProtheses(organisationId: string, implantId: string) {
  return db.select()
    .from(protheses)
    .where(
      and(
        eq(protheses.implantId, implantId),
        eq(protheses.organisationId, organisationId)
      )
    )
    .orderBy(desc(protheses.datePose));
}

ðŸŽ¯ RÃ©sultat attendu

Lâ€™endpoint ne crash plus (plus de variable non dÃ©finie)

Le filtrage par organisationId est correctement appliquÃ©

Les donnÃ©es dâ€™un cabinet ne peuvent pas Ãªtre consultÃ©es par un autre

Lâ€™endpoint rÃ©pond correctement :

[
  {
    "id": "...",
    "implantId": "...",
    "typeProthese": "VISSEE",
    "typePilier": "DROIT",
    "datePose": "2025-12-10",
    "notes": "..."
  }
]