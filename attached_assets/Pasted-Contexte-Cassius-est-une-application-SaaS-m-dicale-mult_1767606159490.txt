Contexte

Cassius est une application SaaS m√©dicale multi-tenant.
Nous devons impl√©menter un syst√®me de notifications robuste, centralis√© et tra√ßable, d√©clench√© par des √©v√©nements m√©tier (ex : ISQ faible, rendez-vous, imports, activit√© √©quipe).

Actuellement :

Les √©v√©nements sont bien cr√©√©s (ex : ISQ = 25)

Les pr√©f√©rences utilisateur existent (In-app / Email / Fr√©quence)

‚ùå Les notifications ne sont ni visibles dans le bandeau, ni envoy√©es par email

Objectif : un syst√®me fiable, coh√©rent, et extensible.

üß† Principe fondamental

üëâ Toute notification passe par UNE seule source de v√©rit√©
Aucune notification ne doit √™tre envoy√©e directement depuis une feature m√©tier.

üß± Architecture attendue
1Ô∏è‚É£ Notification Engine (obligatoire)

Cr√©er un Notification Engine central :

notify(event: NotificationEvent)


Tous les modules (ISQ, rendez-vous, imports, documents, etc.) appellent exclusivement ce moteur.

2Ô∏è‚É£ Types d‚Äô√©v√©nements normalis√©s

Cr√©er une enum claire :

NotificationType =
  | ISQ_CRITICAL
  | ISQ_WARNING
  | APPOINTMENT_REMINDER
  | APPOINTMENT_UPDATED
  | IMPORT_COMPLETED
  | IMPORT_FAILED
  | DOCUMENT_ADDED
  | TEAM_ACTIVITY
  | SYSTEM_UPDATE


Chaque √©v√©nement contient :

{
  type: NotificationType
  organisationId
  patientId?        // jamais de donn√©es sensibles en clair
  entityId?         // implant, visite, document‚Ä¶
  severity?: 'INFO' | 'WARNING' | 'CRITICAL'
  payload?: Record<string, any>
  createdAt
}

3Ô∏è‚É£ Table notifications (In-app)

Cr√©er une table d√©di√©e :

notifications (
  id uuid PK
  organisation_id
  user_id
  type
  severity
  title
  message
  entity_type
  entity_id
  is_read boolean default false
  created_at
)


üëâ Toute notification visible dans le bandeau doit √™tre stock√©e ici.

4Ô∏è‚É£ Table notification_preferences

Par utilisateur et par cat√©gorie :

notification_preferences (
  user_id
  category   -- alerts, activity, imports, system
  in_app boolean
  email boolean
  frequency enum('IMMEDIATE','DAILY','WEEKLY','NONE')
)

üîÑ Flow complet (EXEMPLE ISQ = 25)
√âtape 1 ‚Äî √âv√©nement m√©tier

Lorsqu‚Äôun ISQ est cr√©√© ou modifi√© :

if (isq < 55) {
  notify({
    type: ISQ_CRITICAL,
    severity: 'CRITICAL',
    patientId,
    entityId: implantId,
    organisationId
  })
}

√âtape 2 ‚Äî Notification Engine

Le moteur :

Identifie les utilisateurs concern√©s (organisation + r√¥le)

Charge leurs notification_preferences

Pour chaque utilisateur :

si in_app = true ‚Üí cr√©e une ligne notifications

si email = true ‚Üí enqueue email (voir plus bas)

‚ö†Ô∏è Aucune notification n‚Äôest affich√©e si elle n‚Äôest pas en base

√âtape 3 ‚Äî Bandeau In-app (Frontend)

Le bandeau :

appelle GET /api/notifications

affiche :

badge compteur (unread)

ic√¥ne par s√©v√©rit√©

marque comme lu via POST /api/notifications/:id/read

√âtape 4 ‚Äî Emails (asynchrones)

Cr√©er une table email_outbox :

email_outbox (
  id uuid
  user_id
  type
  subject
  template
  payload
  status enum('PENDING','SENT','FAILED')
  error_message?
  created_at
  sent_at?
)


Le moteur :

√©crit en PENDING

un worker traite l‚Äôenvoi (Resend)

met √† jour SENT ou FAILED

üëâ Jamais d‚Äôemail envoy√© directement depuis un controller

üìß R√®gles Email (s√©curit√© & UX)

Aucune donn√©e patient en clair

Liens sign√©s uniquement

CTA du type :

‚ÄúVoir l‚Äôalerte dans Cassius‚Äù

Expiration des liens

Langue : FR par d√©faut (pr√©voir i18n plus tard)

‚è± Gestion de la fr√©quence

IMMEDIATE ‚Üí notification instantan√©e

DAILY / WEEKLY ‚Üí stocker dans une table notification_digest

Cron job pour g√©n√©rer les emails group√©s

‚úÖ Cas d‚Äôacceptation obligatoires

 ISQ < 55 ‚Üí notification visible imm√©diatement dans le bandeau

 Badge compteur mis √† jour sans refresh

 Email envoy√© si activ√© dans pr√©f√©rences

 D√©sactiver email ‚Üí in-app uniquement

 Aucun email si fr√©quence ‚â† imm√©diat

 Logs clairs en cas d‚Äô√©chec email

 Aucune notif si pr√©f√©rences d√©sactiv√©es

üß™ Debug obligatoire

Ajouter un endpoint admin :

GET /api/notifications/debug?event=ISQ_CRITICAL


Retourne :

utilisateurs cibl√©s

pr√©f√©rences appliqu√©es

in_app cr√©√© ? email enqueue ?

raison si ignor√©