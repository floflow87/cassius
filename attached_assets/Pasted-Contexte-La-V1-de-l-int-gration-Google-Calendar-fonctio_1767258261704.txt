Contexte
La V1 de l’intégration Google Calendar fonctionne : Cassius -> Google (création/MAJ d’événements dans un calendrier cible).
Je veux maintenant développer la V2 : Google -> Cassius (récupérer les événements Google et les afficher/importer dans Cassius), avec une synchronisation fiable et idempotente.

Objectifs V2
1) Lire les événements depuis Google Calendar (calendrier sélectionné) sur une plage de dates.
2) Afficher ces événements dans Cassius (dans l’écran Calendrier et/ou dans la page Paramètres Google Calendar).
3) Importer/mettre à jour ces événements dans Cassius sous forme de “rendez-vous” (ou une entité dédiée), en conservant une traçabilité (source=google).
4) Gestion des conflits / déduplication : ne jamais dupliquer le même événement Google dans Cassius.
5) Permettre une synchro bidirectionnelle contrôlée :
   - V1: Cassius -> Google (déjà OK)
   - V2: Google -> Cassius (à construire)
   - gérer les collisions (deux sources modifient le même créneau)

Fonctionnel UI (page Paramètres > Google Calendar)
A) Ajouter une section “Importer depuis Google vers Cassius”
- Toggle : “Importer les événements Google vers Cassius”
- Sélecteur “Calendrier source” (par défaut Primary)
- Sélecteur de période :
  - options rapides: “7 jours”, “30 jours”, “Mois en cours”, “Plage personnalisée”
- Bouton “Importer maintenant”
- Afficher :
  - Dernière importation (date/heure)
  - Résumé import (créés / mis à jour / ignorés / erreurs)
  - Lien vers un rapport (liste des collisions/erreurs)

B) Dans la vue Calendrier Cassius
- Afficher les événements importés de Google (badge “Google”)
- Option filtre : [Tout | Cassius | Google | Conflits]
- En cliquant sur un événement Google importé, ouvrir un drawer/fiche :
  - titre, date/heure, description, participants, lieu
  - lien “Ouvrir dans Google Calendar” (htmlLink)
  - statut (confirmed/cancelled)
  - indicateur “Synchronisé / en conflit”

Backend / Data model (Supabase)
1) Créer une table de mapping idempotente (OBLIGATOIRE) :
   google_calendar_events
   - id uuid PK
   - organisation_id
   - user_id
   - google_calendar_id (string)
   - google_event_id (string) UNIQUE par (organisation_id, google_calendar_id, google_event_id)
   - etag (string)
   - status (confirmed/cancelled)
   - summary (text)
   - description (text)
   - location (text)
   - start_at timestamptz
   - end_at timestamptz
   - all_day boolean
   - attendees jsonb
   - html_link text
   - updated_at_google timestamptz
   - last_synced_at timestamptz
   - cassius_appointment_id (uuid nullable) -> lien vers l’entité RDV Cassius si on choisit d’en créer une
   - created_at / updated_at

2) (Optionnel mais recommandé) Table de conflits:
   sync_conflicts
   - organisation_id, user_id
   - source (google/cassius)
   - entity_type (event/appointment)
   - external_id, internal_id
   - reason (time_overlap, changed_both_sides, deleted, etc.)
   - payload jsonb
   - status (open/resolved/ignored)
   - created_at, resolved_at

API endpoints
1) GET /api/google/calendars (existe déjà)
2) GET /api/google/events?calendarId=...&timeMin=...&timeMax=...&syncToken=...
   - Utiliser Google Calendar API events.list
   - Paramètres:
     - singleEvents=true
     - orderBy=startTime
     - timeMin/timeMax en ISO
     - gérer pagination (nextPageToken)
   - Retourner une liste normalisée d’événements

3) POST /api/google/import
   Body:
   - calendarId
   - timeMin
   - timeMax
   - mode: "preview" | "import"
   Comportement:
   - preview: ne fait que compter + détecter collisions
   - import: upsert dans google_calendar_events + (optionnel) création/MAJ de RDV Cassius
   - Retourne:
     { created, updated, skipped, cancelled, failed, conflicts: [], failures: [] }

4) GET /api/google/import/status (dernier import + stats)
5) PATCH /api/calendar_integration/settings
   - sauvegarder: calendar_source_id, import_enabled, import_range_default, export_enabled, calendar_target_id

Synchro incrémentale (V2.1)
- Mettre en place syncToken (Google incremental sync) :
  - stocker syncToken par (user_id, calendarId)
  - sur import suivant: utiliser syncToken au lieu de timeMin/timeMax
- Gérer les erreurs de syncToken invalid (reset et full sync)

Règles d’idempotence & dédup
- Un événement Google est identifié par (google_calendar_id + google_event_id)
- Utiliser UPSERT en DB sur la contrainte UNIQUE
- Si etag identique et dates identiques -> skip
- Si status=cancelled -> marquer supprimé/annulé côté Cassius (selon règle produit)

Gestion des collisions
- Si un événement Google importé chevauche un RDV Cassius existant:
  - ne pas écraser automatiquement
  - créer une entrée sync_conflicts + afficher dans l’UI
  - proposer une action: “Garder Cassius” / “Garder Google” / “Dupliquer” / “Ignorer”

Logging & erreurs
- Ajouter logs backend structurés (sans tokens)
- Sur erreur, renvoyer un JSON clair:
  { error: "IMPORT_FAILED", step: "...", message: "...", details: ... }

Livrables
- Migrations Supabase pour google_calendar_events (+ sync_conflicts si choisi)
- Endpoints backend pour lire events + preview/import
- UI complète (toggle + calendrier source + période + importer maintenant + résumé + conflits)
- Affichage des événements Google dans le calendrier Cassius avec filtre “Google”
- Test en prod sur un vrai compte Google : importer 7 jours puis 30 jours, vérifier idempotence, vérifier annulations, vérifier conflits.

Contraintes
- Ne pas casser la V1 (Cassius -> Google)
- Code propre, modulaire, facilement extensible vers bidirectionnel complet
- Timezone Europe/Paris
- Respect RGPD: ne pas logger le contenu sensible inutilement
